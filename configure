#!/bin/sh
#
# Installation script for PyXPlot version 0.8.0
#
# The code in this file is part of PyXPlot
# <http://www.pyxplot.org.uk>
#
# Copyright (C) 2006-8 Dominic Ford <coders@pyxplot.org.uk>
#               2008   Ross Church
#
# $Id$
#
# PyXPlot is free software; you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any later
# version.
#
# You should have received a copy of the GNU General Public License along with
# PyXPlot; if not, write to the Free Software Foundation, Inc., 51 Franklin
# Street, Fifth Floor, Boston, MA  02110-1301, USA

# ----------------------------------------------------------------------------

# 0. START CONSTRUCTING A MAKEFILE

echo "" > Makefile
echo "PATHLINK=/" > Makefile

# 1. TEST THE ECHO COMMAND TO SEE WHICH VARIANT WE HAVE

case `echo "testing\c"; echo 1,2,3`,`echo -n testing; echo 1,2,3` in
  *c*,-n*) ECHO_N= ECHO_C='
' ECHO_T='  ' ;;
  *c*,*  ) ECHO_N=-n ECHO_C= ECHO_T= ;;
  *)       ECHO_N= ECHO_C='\c' ECHO_T= ;;
esac

# 2. CHECK FOR LATEX

echo $ECHO_N "Checking for latex             ............. $ECHO_C"
whichout=`which latex 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
 echo "LATEX_COMMAND=${whichout}" >> Makefile
else
 echo "NO" ; echo "ERROR: Required program latex could not be found." >&2 ; exit
fi

# 3. CHECK FOR CONVERT

echo $ECHO_N "Checking for ImageMagick convert............ $ECHO_C"
whichout=`which convert 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
 echo "CONVERT_COMMAND=${whichout}" >> Makefile
else 
 echo "NO" ; echo "ERROR: Required program convert could not be found." >&2 ; exit
fi

# 4. CHECK FOR SED

echo $ECHO_N "Checking for sed               ............. $ECHO_C"
whichout=`which sed 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
 echo "SED_COMMAND=${whichout}" >> Makefile
else 
 echo "NO" ; echo "ERROR: Required program sed could not be found." >&2 ; exit
fi

# 5. CHECK FOR GUNZIP

echo $ECHO_N "Checking for gunzip            ............. $ECHO_C"
whichout=`which gunzip 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
 echo "GUNZIP_COMMAND=-D GUNZIP_COMMAND=\"\\\"${whichout} -c\\\"\"" >> Makefile
else
 echo "NO"
 echo "GUNZIP_COMMAND=" >> Makefile
 echo "WARNING: Gunzip could not be found. Installation will proceed, but PyXPlot will not be able to plot .gz files." >&2
fi

# 6. CHECK FOR WGET

echo $ECHO_N "Checking for wget              ............. $ECHO_C"
whichout=`which wget 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
 echo "WGET_COMMAND=-D WGET_COMMAND=\"\\\"${whichout} -O -\\\"\"" >> Makefile
else
 echo "NO"
 echo "WGET_COMMAND=" >> Makefile
 echo "WARNING: wget could not be found. Installation will proceed, but PyXPlot will not be able to plot files directly from URLs." >&2
fi

# 7. CHECK FOR GHOSTSCRIPT

echo $ECHO_N "Checking for ghostscript       ............. $ECHO_C"
whichout=`which gs 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
 echo "GS_COMMAND=${whichout}" >> Makefile
else
 echo "NO" ; echo "ERROR: Required program ghostscript could not be found." >&2 ; exit
fi

# 8. FIND GHOSTVIEW

echo $ECHO_N "Checking for ghostview         ............. $ECHO_C"
whichout_gv=`which gv 2> /dev/null`
whichout_ggv=`which ggv 2> /dev/null`
if test "`echo $whichout_gv | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout_gv="" ; fi
if test "`echo $whichout_ggv | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout_ggv="" ; fi
if test "$whichout_gv" != "" ; then
 echo $ECHO_N "YES (gv$ECHO_C"
 echo "GV_COMMAND=${whichout_gv}" >> Makefile 
 if test "`gv --v 2> /dev/null`" = "" ; then 
  echo ", single hyphen options)" 
  echo "GV_OPT=-" >> Makefile
 else
  echo ", double hyphen options)" 
  echo "GV_OPT=--" >> Makefile
 fi
elif test "$whichout_ggv" != "" ; then
 echo "YES (ggv, don't forget to set \"watch file\" in the viewer preferences!)"
 echo "GV_COMMAND=${whichout_ggv}" >> Makefile
 echo "GV_OPT=--" >> Makefile
else
 echo "GV_COMMAND=/bin/false" >> Makefile
 echo "NO"
 echo "WARNING: Ghostview could not be found. Installation will proceed, but X11 terminal will not be available in PyXPlot. If required, install either ghostview (gv) or Gnome-ghostview (ggv), and then re-install PyXPlot." >&2
fi

# 9. FIND MAKE

echo $ECHO_N "Checking for GNU make          ............. $ECHO_C"
whichout_make=`which make 2> /dev/null`
whichout_gmake=`which gmake 2> /dev/null`
if test "`echo $whichout_make | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout_make="" ; fi
if test "`echo $whichout_gmake | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout_gmake="" ; fi
if test "$whichout_gmake" != "" ; then
 echo "YES (gmake)"
 echo "MAKE_COMMAND=${whichout_gmake}" >> Makefile
 MAKE_COMMAND="gmake"
elif test "$whichout_make" != "" ; then
 echo "YES (make)"
 echo "MAKE_COMMAND=${whichout_make}" >> Makefile
 MAKE_COMMAND="make"
else
 echo "NO"
 echo "ERROR: Required program 'make' could not be found." >&2
 exit
fi

# 10. CHECK TO SEE WHETHER THIS SYSTEM HAS GNU READLINE HEADERS

echo $ECHO_N "Checking for libreadline-dev   ............. $ECHO_C"
if printf '#include <readline/readline.h>\nint main() { return 0; }\n' | gcc -x c - -o /dev/null > /dev/null 2> /dev/null
then
 echo "YES"
 echo "HAVE_READLINE=-D HAVE_READLINE=1" >> Makefile
else
 echo "NO"
 echo "HAVE_READLINE=-D NOHAVE_READLINE=1" >> Makefile
fi

# 11. CHECK TO SEE WHETHER THIS SYSTEM HAS CFITSIO HEADERS

echo $ECHO_N "Checking for libcfitsio-dev    ............. $ECHO_C"
if printf '#include <fitsio.h>\nint main() { return 0; }\n' | gcc -x c - -o /dev/null > /dev/null 2> /dev/null
then
 echo "YES"
 echo "HAVE_FITSIO=-D HAVE_FITSIO=1" >> Makefile
 echo "FITSIO_LINK=-lcfitsio" >> Makefile
else
 echo "NO"
 echo "HAVE_FITSIO=-D NOHAVE_FITSIO=1" >> Makefile
 echo "FITSIO_LINK=" >> Makefile
fi

# 12. CHECK TO SEE WHETHER THIS SYSTEM HAS GSL HEADERS

echo $ECHO_N "Checking for libgsl0-dev       ............. $ECHO_C"
if printf '#include <gsl/gsl_version.h>\nint main() { return 0; }\n' | gcc -x c - -o /dev/null > /dev/null 2> /dev/null
then
 echo "YES"
else
 echo "NO"
 echo "ERROR: Header files for required library 'libgsl' could not be found." >&2
 exit
fi

# 13. CHECK TO SEE WHETHER THIS SYSTEM HAS LIBXML2 HEADERS

echo $ECHO_N "Checking for libxml2-dev       ............. $ECHO_C"
whichout=`which xml2-config 2> /dev/null`
if test "`echo $whichout | sed 's/\([a-z]*\).*/\1/'`" = "no" ; then whichout="" ; fi
if test "$whichout" != "" ; then
 echo "YES"
else
 echo "NO"
 echo "ERROR: Header files for required library 'libxml2' could not be found." >&2
 exit
fi

# 14. CHECK TO SEE WHETHER THIS SYSTEM HAS LIBPNG HEADERS

echo $ECHO_N "Checking for libpng-dev        ............. $ECHO_C"
if printf '#include <stdlib.h>\n#include <stdio.h>\n#include <png.h>\nint main() { return 0; }\n' | gcc -x c - -o /dev/null > /dev/null 2> /dev/null
then
 echo "YES"
else
 echo "NO"
 echo "ERROR: Header files for required library 'libpng' could not be found." >&2
 exit
fi

# 15. CHECK TO SEE WHETHER THIS SYSTEM HAS KPATHSEA HEADERS

echo $ECHO_N "Checking for libkpathsea-dev   ............. $ECHO_C"
if printf '#include <stdlib.h>\n#include <stdio.h>\n#include <kpathsea/kpathsea.h>\nint main() { return 0; }\n' | gcc -x c - -o /dev/null > /dev/null 2> /dev/null
then
 echo "YES"
else
 echo "NO"
 echo "ERROR: Header files for required library 'libkpathsea-dev' could not be found." >&2
 exit
fi

# 16. OUTPUT MAKEFILE

cat Makefile.skel >> Makefile

echo "Configuration successful."
echo "To continue installation, type '${MAKE_COMMAND}'."

